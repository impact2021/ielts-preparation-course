# Version 2.15 Implementation Summary

## Overview
Version 2.15 addresses user feedback and bug fixes related to the Computer-Based Test (CBT) experience, including moving the "Return to course" link, fixing feedback display for unanswered questions, and properly formatting question text with paragraph breaks.

## Changes Implemented

### 1. Version Update
- **File**: `ielts-course-manager.php`
- **Changes**:
  - Updated plugin version header from 2.14 to 2.15
  - Updated `IELTS_CM_VERSION` constant from '2.14' to '2.15'

### 2. Moved "Return to Course" Link from Modal to Fullscreen Page
- **Issue**: The "Return to course" link was in the quiz completion popup, but users wanted it on the fullscreen page itself for easier access.

- **Files Modified**: 
  - `templates/single-quiz-computer-based.php`
  - `assets/js/frontend.js`
  
- **Template Changes (single-quiz-computer-based.php)**:
  - Added a new "Return to course" link section after the quiz result area (lines 249-255)
  - Link only displays when in fullscreen mode (`$is_fullscreen`) AND quiz is linked to a course (`$course_id`)
  - Positioned with centered text alignment and proper spacing
  - Uses WordPress escaping functions for security (`esc_url()`)
  
- **JavaScript Changes (frontend.js)**:
  - Removed the logic that added "Return to course" button to the modal (lines 603-612)
  - Left the cleanup code that removes any old buttons (for backward compatibility)
  - Updated comment to indicate this is no longer used in v2.15
  
- **Rationale**: Moving the link to the main page provides better UX as users can access it without closing the modal, and it's visible at all times after quiz completion.

### 3. Show Question Feedback for Unanswered Questions
- **Issue**: When a user didn't enter an answer for a question, no feedback was shown. Users wanted to see feedback even for unanswered questions.

- **File**: `includes/class-quiz-handler.php`
- **Changes**:
  - Added an `else` block to the answer processing logic (lines 95-99)
  - When no answer is provided (`!isset($answers[$index])`), the code now checks for `incorrect_feedback` and displays it
  - Applies the same security filtering (`wp_kses_post()`) as other feedback
  
- **Behavior**:
  - Questions with no answer will show as incorrect (as expected)
  - If `incorrect_feedback` is configured for the question, it will be displayed
  - This helps students understand what they missed even when they skipped a question
  
- **Backward Compatibility**: Questions without `incorrect_feedback` configured will simply show no feedback (same as before)

### 4. Fixed Paragraph Breaks in Question Text
- **Issue**: When question text included paragraph breaks (line breaks), they were not displayed - all text appeared as one block.

- **Files Modified**: 
  - `templates/single-quiz-computer-based.php`
  - `templates/single-quiz.php`
  
- **Changes**:
  - Applied `wpautop()` function to question text before displaying
  - Changed from: `<?php echo wp_kses_post($question['question']); ?>`
  - Changed to: `<?php echo wp_kses_post(wpautop($question['question'])); ?>`
  - Applied to both CBT and regular quiz templates
  
- **How it Works**:
  - `wpautop()` is a WordPress core function that converts line breaks to `<p>` and `<br>` tags
  - It respects double line breaks as paragraph breaks and single line breaks as `<br>` tags
  - `wp_kses_post()` still filters the HTML for security, allowing only safe tags
  
- **Effect**: Question text with paragraph breaks will now display properly formatted with visual spacing between paragraphs.

## Files Modified

1. `ielts-course-manager.php` - Version number updates
2. `templates/single-quiz-computer-based.php` - Added "Return to course" link, fixed paragraph breaks
3. `templates/single-quiz.php` - Fixed paragraph breaks
4. `includes/class-quiz-handler.php` - Show feedback for unanswered questions
5. `assets/js/frontend.js` - Removed "Return to course" button from modal

## Testing Notes

### Test Case 1: Version Update
- [x] Plugin version displays as 2.15 in WordPress admin
- [x] Version constant is correctly set to 2.15

### Test Case 2: Return to Course Link Location
To test this feature:
1. Create or edit a CBT quiz linked to a course and lesson
2. Open the quiz in fullscreen mode (click "Open in Fullscreen" button)
3. Complete and submit the quiz
4. Verify:
   - "Return to course" link appears below the quiz result area on the main page
   - Link is centered and styled as a WordPress button
   - Link does NOT appear in the results modal popup
   - Clicking the link navigates to the course page
   - Link only appears in fullscreen mode (not when viewing quiz normally)
   - Link only appears when quiz is linked to a course

### Test Case 3: Feedback for Unanswered Questions
To test this feature:
1. Create a quiz with questions that have `incorrect_feedback` configured
2. Take the quiz but intentionally skip some questions (leave them blank)
3. Submit the quiz
4. Click "Review my answers" (for CBT quizzes) or scroll to feedback section
5. Verify:
   - Unanswered questions show as incorrect (expected behavior)
   - Feedback text appears for unanswered questions (if configured)
   - Feedback formatting is consistent with answered questions
   - User answer shows as "(No answer provided)"

### Test Case 4: Paragraph Breaks in Question Text
To test this feature:
1. Create or edit a quiz question
2. Enter question text with paragraph breaks:
   ```
   This is the first paragraph.

   This is the second paragraph after a blank line.

   This is the third paragraph.
   ```
3. Save the question
4. View the quiz as a student
5. Verify:
   - Paragraphs are visually separated with proper spacing
   - Double line breaks create paragraph spacing
   - Text is no longer displayed as one continuous block
   - Formatting works in both CBT and regular quiz layouts

## Backward Compatibility
- All changes are backward compatible
- Existing quizzes will automatically benefit from the fixes
- "Return to course" link only appears in fullscreen mode to avoid confusion
- Questions without `incorrect_feedback` simply show no feedback (as before)
- Question text without line breaks displays unchanged

## Security Considerations
- ✅ "Return to course" URL is escaped using `esc_url()`
- ✅ Feedback text continues to use `wp_kses_post()` for HTML filtering
- ✅ `wpautop()` does not introduce security vulnerabilities (core WordPress function)
- ✅ No direct HTML string concatenation that could introduce XSS
- ✅ All user input is properly sanitized and escaped

## Performance Considerations
- `wpautop()` is a lightweight function with minimal performance impact
- No additional database queries added
- Feedback processing logic has same performance characteristics as before
- "Return to course" link is rendered server-side (no additional AJAX calls)

## Known Limitations
1. "Return to course" link only appears in fullscreen mode (by design)
2. "Return to course" link only appears when quiz is linked to a course (by design)
3. Feedback for unanswered questions only appears if `incorrect_feedback` is configured
4. `wpautop()` may add extra `<p>` tags if question text already contains HTML paragraphs

## User Impact
- **Positive**: Better UX with "Return to course" link always visible on main page
- **Positive**: Students get feedback even when they skip questions (helps learning)
- **Positive**: Question text with paragraphs displays properly (better readability)
- **Neutral**: No breaking changes or functionality removed
- **Minimal Learning Curve**: Changes are intuitive and require no user training

## Future Enhancements
Potential future improvements:
- Add option to show "Return to lesson" link in addition to "Return to course"
- Allow customization of the "Return to course" link text through settings
- Add configuration option to control whether unanswered questions show feedback
- Support for more advanced text formatting options in question editor
