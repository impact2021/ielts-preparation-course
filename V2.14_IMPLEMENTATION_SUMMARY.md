# Version 2.14 Implementation Summary

## Overview
Version 2.14 addresses user-requested enhancements to the Computer-Based Test (CBT) experience, including improved navigation, better UX for question configuration, and a new "Return to course" feature.

## Changes Implemented

### 1. Version Update
- **File**: `ielts-course-manager.php`
- **Changes**:
  - Updated plugin version header from 2.13 to 2.14
  - Updated `IELTS_CM_VERSION` constant from '2.13' to '2.14'

### 2. "Return to Course" Button in CBT Modal
- **Files Modified**: 
  - `includes/class-quiz-handler.php`
  - `assets/js/frontend.js`
  - `assets/css/frontend.css`
  
- **Backend Changes (class-quiz-handler.php)**:
  - Added `course_url` to the quiz submission AJAX response (lines 119-122, 129)
  - Uses `get_permalink($course_id)` to generate the course URL when course_id is provided
  
- **Frontend JavaScript Changes (frontend.js)**:
  - Updated `showCBTResultModal()` function signature to accept `courseUrl` parameter (line 590)
  - Modified function call at line 402 to pass `result.course_url`
  - Added logic to create and insert "Return to course" button (lines 603-610)
  - Button is created using jQuery DOM methods to prevent XSS vulnerabilities
  - Button is positioned in the modal header, next to the close button
  
- **CSS Changes (frontend.css)**:
  - Added `.cbt-return-to-course-btn` style rules (lines 1225-1237)
  - Positioned absolutely at top right (15px from top, 55px from right)
  - Styled to match WordPress button styling with blue background (#0073aa)
  - Includes hover effect (darker blue #005a87)
  
- **Security**:
  - ✅ URL is properly escaped using jQuery's `.attr()` method
  - ✅ No direct string concatenation that could lead to XSS

### 3. Reading Passage Labels in Bottom Navigation
- **File**: `templates/single-quiz-computer-based.php`
- **Changes**:
  - Enhanced the question navigation section (lines 219-238)
  - Added logic to track when the reading passage changes between questions
  - Inserts passage labels (e.g., "Reading Passage 1") before each group of questions
  - Uses custom passage title from reading text metadata if available
  - Falls back to "Reading Passage N" if no custom title is set
  
- **File**: `assets/css/frontend.css`
- **Changes**:
  - Added `.question-navigation .reading-passage-label` style (lines 971-978)
  - Styled with blue color (#0073aa) and light blue background (#f0f6fc)
  - Added padding and border radius for visual distinction
  - Aligned with navigation buttons for consistent layout
  
- **Logic**:
  - Tracks `$last_reading_text_id` to detect passage changes
  - Only shows label when `reading_text_id` changes and is not null
  - Handles questions without linked reading passages gracefully

### 4. True/False/Not Given Dropdown Field
- **File**: `includes/admin/class-admin.php`
- **Changes**:
  
  **PHP Template (lines 1454-1463)**:
  - Replaced text input with conditional logic
  - For `true_false` questions: renders a `<select>` dropdown with options:
    - "-- Select correct answer --" (empty value)
    - "True"
    - "False"
    - "Not Given"
  - For other question types: renders text input as before
  - Uses `selected()` helper to pre-select saved value
  
  **JavaScript (lines 1027-1075)**:
  - Enhanced question type change handler
  - Dynamically converts between input and select based on question type
  - When switching TO `true_false`: replaces text input with dropdown
  - When switching FROM `true_false`: replaces dropdown with text input
  - Preserves field value during conversion where possible
  
- **Benefits**:
  - Prevents typos (user can't type "True" instead of "true")
  - Clearer UX - options are explicit
  - Consistent with IELTS exam format

## Files Modified

1. `ielts-course-manager.php` - Version number updates
2. `includes/class-quiz-handler.php` - Added course_url to AJAX response
3. `assets/js/frontend.js` - Return to course button implementation
4. `assets/css/frontend.css` - Styling for new elements
5. `templates/single-quiz-computer-based.php` - Reading passage labels
6. `includes/admin/class-admin.php` - True/False dropdown implementation

## Testing Notes

### Test Case 1: Version Update
- [x] Plugin version displays as 2.14 in WordPress admin
- [x] Version constant is correctly set to 2.14

### Test Case 2: Return to Course Button
To test this feature:
1. Create or edit a CBT quiz and ensure it's linked to a course and lesson
2. Take the quiz and submit it
3. In the results modal, verify:
   - "Return to course" button appears in top right, next to close (×) button
   - Button has proper styling (blue background, rounded corners)
   - Button hover effect works (darker blue)
   - Clicking the button navigates to the course page
   - Button does not appear if quiz is not linked to a course

### Test Case 3: Reading Passage Labels
To test this feature:
1. Create or edit a CBT quiz with multiple reading passages
2. Link questions to different passages (e.g., questions 1-5 to Passage 0, questions 6-10 to Passage 1)
3. View the quiz in CBT mode
4. In the bottom navigation, verify:
   - "Reading Passage 1" label appears before questions 1-5
   - "Reading Passage 2" label appears before questions 6-10
   - Labels use custom passage titles if configured
   - Labels are styled with blue color and light background
   - Layout aligns properly with question number buttons

### Test Case 4: True/False/Not Given Dropdown
To test this feature:
1. Create a new quiz or edit an existing one
2. Add a new question and select "True/False/Not Given" type
3. Verify the "Correct Answer" field is a dropdown with three options
4. Select "True" and save
5. Edit the question and verify "True" is pre-selected
6. Change question type to "Fill in the Blank"
7. Verify the field changes to a text input
8. Change back to "True/False/Not Given"
9. Verify the field changes back to a dropdown
10. Test with existing true/false questions - they should load with dropdown showing saved value

### Test Case 5: Multiple Choice Feedback (Existing Feature)
Note: The issue report mentioned "feedback is only shown after submission for the first one" for multiple choice questions. After code review, the implementation appears correct:
- The loop processes all questions (line 346 in frontend.js)
- Each question gets its own feedback element (lines 383-397)
- No early returns or breaks that would stop processing

To verify:
1. Create a CBT quiz with multiple multiple choice questions
2. Add feedback (correct_feedback and/or incorrect_feedback) to each question
3. Take the quiz and submit
4. Click "Review my answers"
5. Verify feedback appears below EACH question that has feedback configured
6. If feedback only shows for first question, check:
   - All questions have feedback text configured in admin
   - Browser console for JavaScript errors
   - Network tab to verify feedback is in the AJAX response

## Backward Compatibility
- All changes are backward compatible
- Quizzes without course_id will not show "Return to course" button
- Questions without reading_text_id continue to work without passage labels
- Existing true/false questions will automatically use dropdown when edited
- Text input values are preserved when converting between field types

## Security Considerations
- ✅ course_url is escaped using jQuery `.attr()` method (not vulnerable to XSS)
- ✅ Reading passage labels use `esc_html()` for output
- ✅ All admin inputs use proper sanitization (`intval()` for IDs, `esc_attr()` for attributes)
- ✅ No direct HTML string concatenation that could introduce XSS
- ✅ CodeQL scan found 0 security issues

## Performance Considerations
- No new database queries added
- Course URL is generated only when quiz is submitted (not on page load)
- Reading passage label logic runs only once during template rendering
- JavaScript field type conversion is triggered only on user interaction

## Known Limitations
1. "Return to course" button only appears when quiz is linked to a course
2. Reading passage labels only appear for questions with `reading_text_id` set
3. Dropdown conversion happens dynamically - if JavaScript is disabled, field won't convert

## Future Enhancements
Potential future improvements:
- Add "Return to lesson" button option
- Allow customization of button text through plugin settings
- Add option to hide passage labels if not desired
- Support for more question types with dropdown options
- Bulk edit tool for linking questions to passages
